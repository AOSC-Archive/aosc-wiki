---
title: 软件包站点
description: 关于软件包站点的一切
published: true
date: 2020-08-22T15:35:00.135Z
tags: infra
editor: markdown
---

# 软件包站点

基于 [paklist](https://github.com/AOSC-Dev/paklist) 的 AOSC OS [软件包站点](https://packages.aosc.io/) 在 2017 首次推出，旨在展示软件仓库及软件包信息。

## 用法

### 面向用户

- "Latest Source Updates" 板块：展示了 Git 仓库中最新的提交。
- "Repositories and Trees" 板块："repositories" 指代的是 DPKG 仓库而 "trees" 指代的是 ABBS 仓库。"Ghost" 指代一个软件在 DPKG 仓库而不在 ABBS 仓库中。"Lagging" 指代的是 ABBS 仓库中某个软件的最新版本缺失对应的二进制包。"Missing" 指代的是一个软件在 ABBS 仓库而不在 DPKG 仓库中。"Source Tree" 中的链接指向相应的 GitHub 页面。"Outdated" 指代的是一个软件在上游有新版本可用。点击表格上的数字，你会得到相应的软件清单。
- 软件包详情页中的 Changelog 由 Git 提交记录自动生成。
- 可以在 https://packages.aosc.io/query/ 使用受限的 SQL 语句进行查询。如果你有生成自定义报告的需要，这个页面将会在很大程度上帮到你。

### 面向机器

- 将请求参数设置为 `?type=json`或者使用 `X-Requested-With: XMLHttpRequest` 请求头即可得到一个 JSON 响应。你可以使用 `page=?` 来分页，或者使用 `page=all` 来禁用分页。
- 获取 API 版本：https://packages.aosc.io/api_version
- 获取软件包列表：https://packages.aosc.io/list.json
- 获取 SQLite3 数据库拷贝：https://packages.aosc.io/data/abbs.db 以及 `piss.db`。
- 获取可以被清理的 DEB 包列表：https://packages.aosc.io/cleanmirror/(repo)，其中 `(repo)` 可以被替换为 `amd64` 或 `amd64/testing` 等仓库。

## 项目框架

这个网站由数个子项目组成，大部分项目使用 Python 实现。部分子项目可被单独使用。

### abbs-meta

[abbs-meta](https://github.com/AOSC-Dev/abbs-meta) is used to extract information from abbs tree and its Git repo. First, it use `reposync.py` to convert Git to Fossil repo. We use Fossil because the Git API is hard to use, calling external programs and writing temp files are slow, and Fossil repo database is easy to use directly. Then, we updated the `abbs.db` database for each commit, to preserve history. This operation modifies `package_*` tables. Syncing this from scratch may cost 10 hours. `bashvar.py` can parse most spec files. It calls bash when there are complex string operations. There are tools to add checksums (`addchksum.{py,sh}`) and to increase REL (`increaserel.py`).

### packages-site

[packages-site](https://github.com/AOSC-Dev/packages-site) is the website backend. `dpkgrepo.py` is used to record the DPKG packages information. This operation modifies `dpkg_*` tables. The package source definition is in `dpkgrepo.py`. The update process is shown in `update.sh`. The website updates once an hour. There is one hour of proxy/CDN/browser cache, so the delay may be 2 hours.
The website is served in `main.py`. We use [Bottle](https://bottlepy.org/) framework and Jinja2 template system. A lot of scary SQL is used to generate the reports. Version comparison is done using an extension for SQLite, which must be built first using `make`.

### piss

[piss](https://github.com/AOSC-Dev/piss), "Projects Information Storage System", is a software version checker. For each package in abbs.db, it first guesses the upstream type using the URL, then do at most two requests to get the version/tag/file list. A lot of heuristics are used to get the latest version from the list. Then it stores the information in piss.db. If all guesses are wrong, it uses https://release-monitoring.org/. The database is updated every four hours.

### Closely related

- https://github.com/gumblex/bottle-sqlite, patched Bottle SQLite plugin with custom function/collation/aggregate/extension support.
- https://github.com/gumblex/htmllisting-parser, parses various directory listings generated by nginx/apache/other web servers.
- https://github.com/gumblex/fossilpy, Fossil repo read-only support in Python.

## 部署

我们建议你预留至少 1GiB 的可用空间（当前使用量是 450 MiB）及至少 512MiB 的 RAM（实际使用不会超过 100M）。另外你需要安装 Python 3.5+ 或 PyPy3.5、带有 FTS5 支持的 SQLite3、Fossil 2.6+、bash 和 Git。

我们目前使用 uWSGI 和 NGINX 来托管网站，请前往 https://github.com/AOSC-Dev/packages-site#deploy 了解部署流程。接下来你还要为 update.sh 和 piss 设置 Systemd Timers。

## 计划

> 请查看 [英文页面对应部分](https://wiki.aosc.io/en/infra-packages-site#plans) 查看实时内容。
{.is-info}


# 常见问题

## 站点无法访问

请尝试访问镜像站点 https://aoscpkgs.gumble.pw/ ，接下来烦请在 Telegram 群中联系站点管理员 @gumblex 反映问题。 

## 站点数据过期

请先访问 https://packages.aosc.io/aosc-os-abbs/timeline 看看是否为 git-to-fossil 同步问题，然后访问 https://packages.aosc.io/updates 看看同步是不是真的出了问题。如果是 git-to-fossil 同步不工作，那么问题通常由强制推送或变基操作导致的。如果不是这样的话，烦请联系站点管理员反馈问题。

## 某个软件包不是最新的

如果你确认软件包站点同步功能工作正常（见上文），你的更新包可能在 `bugfix` 分支中。虽然目前软件包站点不显示任何关于 `bugfix` 分支的信息，但这些信息在我们的数据库中会有很好的记录。相关工作仍在咕咕咕，但是你可以随时在 Telegram 群或邮件列表中为我们提供关于「如何在软件包站点展示不同分支的内容」的建议。

## 上游版本是错的

A: PISS uses a lot of heuristics, and resorts to Anitya if we can't figure out. Therefore, there are two sources of errors. If the error is on our side, we can improve the heuristics, or give it more information. Currently the only information we can use is package name, current version, url, source type (tarball/git/hg).

## 为什么没有依赖关系图

A: Too big to draw. There are also many cyclic dependencies.
